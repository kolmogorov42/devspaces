schemaVersion: 2.2.0
metadata:
  name: Quarkus Java 17
components:
  - name: tools
    container:
      image: registry.redhat.io/devspaces/udi-rhel8@sha256:bb951a5040851e9f17ca0d21771b428296326753363fd4d2b87ab1f7d35e72b3
      env:
        - name: QUARKUS_HTTP_HOST
          value: 0.0.0.0
      endpoints:
        - exposure: none
          name: debug
          protocol: tcp
          targetPort: 5005
        - exposure: public
          name: hello
          protocol: http
          targetPort: 8080
          #path: /hello/greeting/devspaces-user
      volumeMounts:
        - name: m2
          path: /home/user/.m2
      cpuLimit: '3'
      cpuRequest: '1'
      memoryLimit: 7.5G
      memoryRequest: 4G
      mountSources: true
  - name: m2
    volume:
      size: 1G
  - name: mysql
    container:
#      image: docker.io/library/mysql:8.0
      image: image-registry.openshift-image-registry.svc:5000/openshift/mysql:8.0
      env:
        - name: MYSQL_ROOT_PASSWORD
          value: password
        - name: MYSQL_USER
          value: myuser
        - name: MYSQL_PASSWORD
          value: password
        - name: MYSQL_DATABASE
          value: mydb
      endpoints:
        - name: mysql-port
          protocol: tcp
          targetPort: 3306
          exposure: public
      cpuLimit: 100m
      cpuRequest: 50m
      memoryRequest: 10Mi
      memoryLimit: 50Mi
events:
  postStart:
    - install-java-17
    - proxy-settings-xml
commands:
  - id: install-java-17
    exec:
      label: Configure Java 17
      component: tools
      workingDir: /home/tooling/.java/current
      commandLine: rm -f * && ln -s /usr/lib/jvm/java-17-openjdk/* .
  - id: proxy-settings-xml
    exec:
      label: Add proxy to maven settings
      component: tools
      workingDir: /home/user/.m2
      commandLine: echo "PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHNldHRpbmdzIHhtbG5zPSJodHRwOi8vbWF2ZW4uYXBhY2hlLm9yZy9TRVRUSU5HUy8xLjAuMCIKICAgICAgICAgIHhtbG5zOnhzaT0iaHR0cDovL3d3dy53My5vcmcvMjAwMS9YTUxTY2hlbWEtaW5zdGFuY2UiCiAgICAgICAgICB4c2k6c2NoZW1hTG9jYXRpb249Imh0dHA6Ly9tYXZlbi5hcGFjaGUub3JnL1NFVFRJTkdTLzEuMC4wIGh0dHA6Ly9tYXZlbi5hcGFjaGUub3JnL3hzZC9zZXR0aW5ncy0xLjAuMC54c2QiPgogIDxwbHVnaW5Hcm91cHM+CiAgPC9wbHVnaW5Hcm91cHM+CiAgPHByb3hpZXM+CiAgICA8cHJveHk+CiAgICAgIDxpZD5pc3RhdC1odHRwPC9pZD4KICAgICAgPGFjdGl2ZT50cnVlPC9hY3RpdmU+CiAgICAgIDxwcm90b2NvbD5odHRwPC9wcm90b2NvbD4KICAgICAgPGhvc3Q+cHJveHkuaXN0YXQuaXQ8L2hvc3Q+CiAgICAgIDxwb3J0PjgwODA8L3BvcnQ+CiAgICAgIDxub25Qcm94eUhvc3RzPmNsdXN0ZXIubG9jYWwsLmlzdGF0Lml0LC5zdmMsMTAuMC4wLjAvMTYsMTAuMTI4LjAuMC8xNCwxMC4xOC4xMDguMC8yNCwxMjcuMC4wLjEsMTcyLjMwLjAuMC8xNixhcGktaW50LnBhYXMuY2xvdWQuc3ZpbHVwcG8uaXN0YXQuaXQsbG9jYWxob3N0PC9ub25Qcm94eUhvc3RzPgogICAgPC9wcm94eT4KICAgIDxwcm94eT4KICAgICAgPGlkPmlzdGF0LWh0dHBzPC9pZD4KICAgICAgPGFjdGl2ZT50cnVlPC9hY3RpdmU+CiAgICAgIDxwcm90b2NvbD5odHRwPC9wcm90b2NvbD4KICAgICAgPGhvc3Q+cHJveHkuaXN0YXQuaXQ8L2hvc3Q+CiAgICAgIDxwb3J0PjgwODA8L3BvcnQ+CiAgICAgIDxub25Qcm94eUhvc3RzPmNsdXN0ZXIubG9jYWwsLmlzdGF0Lml0LC5zdmMsMTAuMC4wLjAvMTYsMTAuMTI4LjAuMC8xNCwxMC4xOC4xMDguMC8yNCwxMjcuMC4wLjEsMTcyLjMwLjAuMC8xNixhcGktaW50LnBhYXMuY2xvdWQuc3ZpbHVwcG8uaXN0YXQuaXQsbG9jYWxob3N0PC9ub25Qcm94eUhvc3RzPgogICAgPC9wcm94eT4KICA8L3Byb3hpZXM+CiAgPHNlcnZlcnM+CiAgPC9zZXJ2ZXJzPgogIDxtaXJyb3JzPgogIDwvbWlycm9ycz4KICA8cHJvZmlsZXM+CiAgPC9wcm9maWxlcz4KPC9zZXR0aW5ncz4KCg==" | base64 -d > settings.xml
  - id: 1-package
    exec:
      label: 1. Package the application
      component: tools
      workingDir: ${PROJECTS_ROOT}/quarkus-quickstarts/getting-started
      commandLine: mvn package
      group:
        kind: build
        isDefault: true
  - id: 2-startdev
    exec:
      label: 2. Start Development mode (Hot reload + debug)
      component: tools
      workingDir: ${PROJECTS_ROOT}/quarkus-quickstarts/getting-started
      commandLine: mvn compile quarkus:dev
      group:
        kind: run
        isDefault: true


